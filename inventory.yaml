vars:
  registry: <container-registry>
  quay_registry: quay.io/mongodb/mongodb-enterprise-operator
  s3_bucket: s3://enterprise-operator-dockerfiles/dockerfiles/mongodb-enterprise-operator

images:
  - name: operator
    vars:
      context: .
      template_context: docker/mongodb-enterprise-operator

    inputs:
    - release_version
    - log_automation_config_diff

    stages:
    - name: operator-context-dockerfile
      task_type: docker_build

      dockerfile: docker/mongodb-enterprise-operator/Dockerfile.builder
      buildargs:
        release_version: $(inputs.params.release_version)
        log_automation_config_diff: $(inputs.params.log_automation_config_diff)

      output:
      - registry: $(inputs.params.registry)/operator-context
        tag: $(inputs.params.version_id)

    - name: operator-template-ubi
      task_type: dockerfile_template
      tags: ["ubi"]
      distro: ubi

      inputs:
      - release_version
      - debug

      output:
      - dockerfile: docker/mongodb-enterprise-operator/Dockerfile.ubi-$(inputs.params.version_id)
      - dockerfile: docker/mongodb-enterprise-operator/Dockerfile.ubi-$(inputs.params.release_version)

    - name: operator-template-ubuntu
      task_type: dockerfile_template
      tags: ["ubuntu"]
      distro: ubuntu

      inputs:
      - release_version
      - debug

      output:
      - dockerfile: docker/mongodb-enterprise-operator/Dockerfile.ubuntu-$(inputs.params.version_id)
      - dockerfile: docker/mongodb-enterprise-operator/Dockerfile.ubuntu-$(inputs.params.release_version)

    - name: operator-ubuntu-build
      task_type: docker_build
      tags: ["ubuntu"]

      dockerfile: docker/mongodb-enterprise-operator/Dockerfile.ubuntu-$(inputs.params.version_id)
      buildargs:
        imagebase: $(inputs.params.registry)/operator-context:$(inputs.params.version_id)

      output:
      - registry: $(inputs.params.registry)/ubuntu/mongodb-enterprise-operator
        tag: $(inputs.params.version_id)

      - registry: $(inputs.params.registry)/ubuntu/mongodb-enterprise-operator
        tag: latest

    - name: operator-ubi-build
      task_type: docker_build
      tags: ["ubi"]

      dockerfile: docker/mongodb-enterprise-operator/Dockerfile.ubi-$(inputs.params.version_id)
      buildargs:
        imagebase: $(inputs.params.registry)/operator-context:$(inputs.params.version_id)

      output:
      - registry: $(inputs.params.registry)/ubi/mongodb-enterprise-operator
        tag: $(inputs.params.version_id)
      - registry: $(inputs.params.registry)/ubi/mongodb-enterprise-operator
        tag: latest

    - name: operator-context-release
      task_type: tag_image
      tags: ["release"]

      source:
        registry: $(inputs.params.registry)/operator-context
        tag: $(inputs.params.version_id)

      destination:
      - registry: $(inputs.params.quay_registry)
        tag: $(inputs.params.release_version)-context

    - name: operator-template-ubi
      task_type: dockerfile_template
      tags: ["release"]
      distro: ubi

      inputs:
      - release_version

      output:
      - dockerfile: $(inputs.params.s3_bucket)/Dockerfile.ubi-$(inputs.params.release_version)

    - name: operator-template-ubuntu
      task_type: dockerfile_template
      tags: ["release"]
      distro: ubuntu

      inputs:
      - release_version

      output:
      - dockerfile: $(inputs.params.s3_bucket)/Dockerfile.ubuntu-$(inputs.params.release_version)

  - name: operator-daily-build
    vars:
      context: .

    stages:
    - name: build-ubuntu
      task_type: docker_build

      inputs:
      - build_id

      dockerfile: $(inputs.params.s3_bucket_http)/Dockerfile.ubuntu-$(inputs.params.release_version)
      buildargs:
        imagebase: $(inputs.params.quay_registry):$(inputs.params.release_version)-context

      output:
      - registry: $(inputs.params.quay_registry)
        tag: $(inputs.params.release_version)
      - registry: $(inputs.params.quay_registry)
        tag: $(inputs.params.release_version)-b$(inputs.params.build_id)

    - name: build-ubi
      task_type: docker_build

      inputs:
      - build_id

      dockerfile: $(inputs.params.s3_bucket_http)/Dockerfile.ubi-$(inputs.params.release_version)
      buildargs:
        imagebase: $(inputs.params.quay_registry):$(inputs.params.release_version)-context

      output:
      - registry: $(inputs.params.quay_registry)-ubi
        tag: $(inputs.params.release_version)
      - registry: $(inputs.params.quay_registry)-ubi
        tag: $(inputs.params.release_version)-b$(inputs.params.build_id)
      - registry: $(inputs.params.rh_registry)
        tag: $(inputs.params.release_version)
      - registry: $(inputs.params.rh_registry)
        tag: $(inputs.params.release_version)-b$(inputs.params.build_id)
