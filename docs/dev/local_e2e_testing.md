# Local development and E2E testing

- [Local development and E2E testing](#local-development-and-e2e-testing)
  * [Prepare local environment](#prepare-local-environment)
  * [Multi-cluster development](#multi-cluster-development)
    + [Context variables](#context-variables)
    + [Example context file - run local tests against Kind clusters on remote EVG host](#example-context-file---run-local-tests-against-kind-clusters-on-remote-evg-host)
    + [Example context file - run local tests against Kind clusters on remote EVG host with cluster-wide operator](#example-context-file---run-local-tests-against-kind-clusters-on-remote-evg-host-with-cluster-wide-operator)
    + [Running tests against Kind clusters](#running-tests-against-kind-clusters)
      - [Prepare env](#prepare-env)
      - [Run the operator locally](#run-the-operator-locally)
        * [From the command line](#from-the-command-line)
        * [From the IDE](#from-the-ide)
      - [Run the tests locally](#run-the-tests-locally)
        * [From the command line](#from-the-command-line-1)
    + [Running tests against Evergreen host](#running-tests-against-evergreen-host)
      - [Prepare EVG host](#prepare-evg-host)
      - [Run the tests locally](#run-the-tests-locally-1)
      - [Other uses of `evg_host.sh` script](#other-uses-of--evg-hostsh--script)
      - [Known issues](#known-issues)
  * [Single-cluster development](#single-cluster-development)
    + [Context variables](#context-variables-1)
    + [Running single-cluster tests on EVG host](#running-single-cluster-tests-on-evg-host)
  * [Cluster wide operator](#cluster-wide-operator)

## Prepare local environment

* For running tests locally (not in a pod), you need Python 3.9 virtual env created from docker/mongodb-enterprise-tests/requirements.txt

## Multi-cluster development

### Context variables

Use and modify context file from `scripts/dev/samples/multi-kind`

### Example context file - run local tests against Kind clusters on remote EVG host

The only difference is in `EVG_HOST` env var:

```bash
export EVG_HOST_NAME=multi-cluster
source ~/.operator-dev/contexts/multi-kind
```

### Example context file - run local tests against Kind clusters on remote EVG host with cluster-wide operator

```bash
export EVG_HOST_NAME=multi-cluster
export OPERATOR_CLUSTER_SCOPED=true
export WATCH_NAMESPACE="lsierant-10-mdb-ns-a,lsierant-10-mdb-ns-b"
source ~/.operator-dev/contexts/multi-kind
```

### Running tests against Kind clusters

#### Prepare env
* `make switch context=<context-name>` - this generates the following files containing environment variables:
    * `~/.operator-dev/context.env` - all env variables from context file in the form: `VAR="VALUE"`. E2E test requires these env variables.
    * `~/.operator-dev/context.export.env` - same as above, but with exported form : `export VAR="VALUE"`, which can be sourced to current session.
    * `~/.operator-dev/context.operator.env` - env variables from the context required by the operator binary in not-exported env form.
    * `~/.operator-dev/context.operator.export.env` - same as above, but in exported form.
* `scripts/dev/recreate_kind_clusters.sh` - recreates all kind clusters for multi-cluster
* `make aws_login` - important to make sure you have up-to-date tokens for ECR.
* `scripts/dev/prepare_local_e2e_run.sh` - cleans/creates current namespace in central and all member clusters; executes multi-cluster cli; installs CRD in central cluster.

#### Run the operator locally

Make sure you have `LOCAL_OPERATOR=true` set in context. Otherwise, the tests will assume the operator is running in a pod. Also when running the operator locally, some additional
steps are performed when preparing the environment in `scripts/dev/scripts/dev/prepare_local_e2e_run.sh`, e.g. executing multi-cluster cli tool.

##### From the command line

Source `~/.operator-dev/context.export.operator.env` file generated by `make switch`:

```bash
source ~/.operator-dev/context.operator.export.env
go run main.go -watch-resource=mongodb -watch-resource=opsmanagers -watch-resource=mongodbusers -watch-resource=mongodbmulti -cluster-names=kind-e2e-cluster-1,kind-e2e-cluster-2,kind-e2e-cluster-3
```

##### From the IDE

Depending on your IDE, set environment variables either from:

* `~/.operator-dev/context.export.operator.env` - exported variables
* `~/.operator-dev/context.operator.env`- plain

Run main.go with arguments:

```
-watch-resource=mongodb -watch-resource=opsmanagers -watch-resource=mongodbusers -watch-resource=mongodbmulti -cluster-names=kind-e2e-cluster-1,kind-e2e-cluster-2,kind-e2e-cluster-3
```

#### Run the tests locally

Make sure you're working in tests venv.

##### From the command line

Source `~/.operator-dev/context.export.env` file generated by `make switch`:

```bash
source ~/.operator-dev/context.export.env
```

Run a whole test file:

```bash
pytest --setup-show tests/multicluster/multi_cluster_replica_set.py
```

Run only one test function (or class) from a file:

```bash
tests/multicluster/multi_cluster_replica_set.py::test_create_mongodb_multi
```

### Running tests against Evergreen host

Testing on Kind clusters deployed on remote host works similar to locally deployed Kind clusters. Tests and the operator is running locally. The differences are:

* kubeconfig generated for remote clusters is copied locally to `~/.operator-dev/evg-host.kubeconfig`.
    * kubeconfig contains api endpoints pointing to `127.0.0.1`.
* ssh tunnels are used to expose these api endpoints at the same ports locally, so for kubectl it's no different from running against local Kind.
* When running tests in pods (operator and tests in pods, not locally), prepare script (`scripts/dev/prepare_local_e2e_run.sh`) is converting localhost api endpoints
  from `evg-host.kubeconfig` to Kind node endpoints, which are accessible from inside the cluster thanks to Istio. This converted kubeconfig is then used as a
  secret `test-pod-kubeconfig` for the tests.
* When using kubectl/k9s you need to provide --kubeconfig `~/.operator-dev/evg-host.kubeconfig` parameter.
    * If you source current context `source ~/.operator-dev/context.export.env`, then it will set KUBECONFIG env var to `~/.operator-dev/evg-host.kubeconfig`. This way there is no
      need to pass `--kubeconfig` parameter explicitly.

#### Prepare EVG host

* Go to https://spruce.mongodb.com/spawn/host and create EC2 instance:
    * Distro: `ubuntu-2004-large`.
    * Use existing key or add new one. Make sure it's used by default by ssh on Mac.
    * ![spawn-new-evg-host](spawn-new-evg-host.png)
    * After creating, edit the name, set e.g. `multi-cluster`.
    * Set this host name into `EVG_HOST_NAME` env var in context.
* Run `scripts/dev/evg_host.sh configure` to configure host by installing necessary software and copying scripts.
* Run `scripts/dev/evg_host.sh recreate-kind-clusters` to create kind clusters on remote host and copy kubeconfig to `~/.operator-dev/evg-host.kubeconfig`.
* Run `scripts/dev/evg_host.sh tunnel` to expose locally all api servers.

#### All steps combined to run test locally

Generally, running tests looks identical to running tests against local Kind clusters.

* [only the first time] `scripts/dev/evg_host.sh configure`
* [only the first time] `scripts/dev/evg_host.sh recreate-kind-clusters`
* [in a new terminal] `scripts/dev/evg_host.sh tunnel` 
* `cp multi-kind context to ~/.operator-dev`
  * `make updates to the env vars marked with <UPDATE ME>`
* `source ~/.operator-dev/contexts/multi-kind`
* `./scripts/dev/prepare_local_e2e_run.sh` - This script creates all the necessary files our test automation relies on. 


#### Other uses of `evg_host.sh` script

* To retrieve again remote kubeconfig without recreating all kind clusters run: `scripts/dev/evg_host.sh get-kubeconfig`.
* To ssh into remote host use: `scripts/dev/evg_host.sh ssh`.

#### Known issues

* When host is restarted it loses some routing configuration. Recreate clusters from scratch in case of any connectivity problems.
* After running `scripts/dev/scripts/dev/prepare_local_e2e_run.sh` you need to always restart the operator binary.

## Single-cluster development

Single cluster local development procedure is similar to multi-cluster. The difference is in context:
* `kube_environment_name=kind`
* `CLUSTER_NAME` must be set to single-cluster kind (e.g. `kind-test-cluster`)

In the operator command line arguments do not pass mongodbmulti watch-resource as it would switch the operator to multi-cluster mode.
```
-watch-resource=mongodb -watch-resource=opsmanagers -watch-resource=mongodbusers
```

### Context variables

Use context file from `scripts/dev/kind`

### Running single-cluster tests on EVG host
The difference vs multi-cluster run is to create only one kind cluster with the following command:
```bash
scripts/dev/evg_host.sh recreate-kind-cluster test-cluster
```
Then set `CLUSTER_NAME=kind-test-cluster` in context file.

Warning: this does not remove kind cluster used for multi-cluster run.
Otherwise, it works the same, but getting kubeconfig into `~/.operator-dev/evg-host.kubeconfig` and using `evg_host.sh tunnel`.  

## Cluster wide operator
In order to run cluster-wide operator there have to be two context variables set for single and multi-cluster run. 
```
export OPERATOR_CLUSTER_SCOPED=true
export WATCH_NAMESPACE="lsierant-10-mdb-ns-a,lsierant-10-mdb-ns-b"
```
