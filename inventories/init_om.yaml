vars:
  quay_registry: quay.io/mongodb/mongodb-enterprise-init-ops-manager
  s3_bucket: s3://enterprise-operator-dockerfiles/dockerfiles/mongodb-enterprise-init-ops-manager

images:
- name: init-ops-manager
  vars:
    context: docker/mongodb-enterprise-init-ops-manager
  
  stages:
  - name: init-ops-manager-build-context
    task_type: docker_build
    dockerfile: Dockerfile.builder

    output:
    - registry: $(inputs.params.registry)/ubuntu/mongodb-enterprise-init-ops-manager-context
      tag: $(inputs.params.version_id)

  - name: init-ops-manager-template-ubuntu
    task_type: dockerfile_template
    template_file_extension: busybox
    tags: ["ubuntu"]

    inputs:
    - version

    output:
    - dockerfile: $(functions.tempfile)

  - name: init-ops-manager-build-ubuntu
    task_type: docker_build
    dockerfile: $(stages['init-ops-manager-template-ubuntu'].outputs[0].dockerfile)
    tags: ["ubuntu"]

    buildargs:
      imagebase: $(inputs.params.registry)/ubuntu/mongodb-enterprise-init-ops-manager-context:$(inputs.params.version_id)

    output:
    - registry: $(inputs.params.registry)/ubuntu/mongodb-enterprise-init-ops-manager
      tag: $(inputs.params.version_id)
    - registry: $(inputs.params.registry)/ubuntu/mongodb-enterprise-init-ops-manager
      tag: latest
  
  - name: init-ops-manager-template-ubi
    task_type: dockerfile_template
    template_file_extension: ubi_minimal
    tags: ["ubi"]

    inputs:
    - version

    output:
    - dockerfile: $(functions.tempfile)
  
  - name: init-ops-manager-build-ubi
    task_type: docker_build
    dockerfile: $(stages['init-ops-manager-template-ubi'].outputs[0].dockerfile)
    tags: ["ubi"]

    buildargs:
      imagebase: $(inputs.params.registry)/ubuntu/mongodb-enterprise-init-ops-manager-context:$(inputs.params.version_id)

    output:
    - registry: $(inputs.params.registry)/ubi/mongodb-enterprise-init-ops-manager
      tag: $(inputs.params.version_id)

  - name: init-ops-manager-release-context
    task_type: tag_image
    tags: ["release"]

    source:
      registry: $(inputs.params.registry)/ubuntu/mongodb-enterprise-init-ops-manager-context
      tag: $(inputs.params.version_id)

    destination:
    - registry: $(inputs.params.quay_registry)
      tag: $(inputs.params.version)-context

  - name: init-ops-manager-template-ubi
    task_type: dockerfile_template
    template_file_extension: ubi_minimal
    tags: ["release"]

    inputs:
    - version

    output:
    - dockerfile: $(inputs.params.s3_bucket)/$(inputs.params.version)/ubi/Dockerfile

  - name: init-ops-manager-template-ubuntu
    task_type: dockerfile_template
    template_file_extension: busybox
    tags: ["release"]

    inputs:
    - version

    output:
    - dockerfile: $(inputs.params.s3_bucket)/$(inputs.params.version)/ubuntu/Dockerfile
