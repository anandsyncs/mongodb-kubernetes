vars:
  quay_registry: quay.io/mongodb/mongodb-agent-ubi
  s3_bucket: s3://enterprise-operator-dockerfiles/dockerfiles/mongodb-agent

images:
  - name: agent-amd64
    vars:
      context: .
      template_context: docker/mongodb-agent-non-matrix

    platform: linux/amd64
    stages:
      - name: mongodb-agent-context
        task_type: docker_build
        dockerfile: docker/mongodb-agent-non-matrix/Dockerfile.builder
        tags: [ "ubi" ]
        buildargs:
          agent_version: $(inputs.params.version)
          tools_version: $(inputs.params.mongodb_tools_url_ubi)
          agent_distro: rhel7_x86_64
          tools_distro: rhel70-x86_64

        labels:
          quay.expires-after: 48h

        output:
          - registry: $(inputs.params.registry)/mongodb-agent-ubi
            tag: $(inputs.params.version)-context-amd64

      - name: mongodb-agent-build-context-release
        task_type: docker_build
        tags: ["release"]
        dockerfile: docker/mongodb-agent-non-matrix/Dockerfile.builder
        buildargs:
          agent_version: $(inputs.params.version)
          tools_version: $(inputs.params.mongodb_tools_url_ubi)
          agent_distro: rhel7_x86_64
          tools_distro: rhel70-x86_64
        output:
          - registry: $(inputs.params.quay_registry)
            tag: $(inputs.params.version)-context-amd64

      - name: mongodb-agent-build
        task_type: docker_build
        tags: [ "ubi" ]
        buildargs:
          imagebase: $(inputs.params.registry)/mongodb-agent-ubi:$(inputs.params.version)-context-amd64
        dockerfile: docker/mongodb-agent-non-matrix/Dockerfile

        labels:
          quay.expires-after: 48h

        output:
        - registry: $(inputs.params.registry)/mongodb-agent-ubi
          tag: $(inputs.params.version)-amd64
        - registry: $(inputs.params.registry)/mongodb-agent-ubi
          tag: latest-amd64

      - name: mongodb-agent-release
        task_type: docker_build
        tags: ["release"]
        dockerfile: docker/mongodb-agent-non-matrix/Dockerfile

        buildargs:
          imagebase: $(inputs.params.quay_registry):$(inputs.params.version)-context-amd64

        labels:
          quay.expires-after: Never

        output:
          - registry: $(inputs.params.quay_registry)
            tag: $(inputs.params.version)-amd64

      - name: mongodb-agent-template-ubi
        task_type: dockerfile_template
        tags: ["release"]
        output:
          - dockerfile: $(inputs.params.s3_bucket)/$(inputs.params.version)/ubi/Dockerfile

  - name: agent-arm64
    vars:
      context: .
      template_context: docker/mongodb-agent-non-matrix

    platform: linux/arm64
    stages:
      - name: mongodb-agent-context
        task_type: docker_build
        dockerfile: docker/mongodb-agent-non-matrix/Dockerfile.builder
        tags: [ "ubi" ]
        buildargs:
          agent_version: $(inputs.params.version)
          tools_version: $(inputs.params.mongodb_tools_url_ubi)
          agent_distro: amzn2_aarch64
          tools_distro: rhel82-aarch64

        labels:
          quay.expires-after: 48h

        output:
          - registry: $(inputs.params.registry)/mongodb-agent-ubi
            tag: $(inputs.params.version)-context-arm64

      - name: mongodb-agent-build-context-release
        task_type: docker_build
        tags: ["release"]
        dockerfile: docker/mongodb-agent-non-matrix/Dockerfile.builder
        buildargs:
          agent_version: $(inputs.params.version)
          tools_version: $(inputs.params.mongodb_tools_url_ubi)
          agent_distro: amzn2_aarch64
          tools_distro: rhel82-aarch64
        output:
          - registry: $(inputs.params.quay_registry)
            tag: $(inputs.params.version)-context-arm64

      - name: mongodb-agent-build
        task_type: docker_build
        tags: [ "ubi" ]
        buildargs:
          imagebase: $(inputs.params.registry)/mongodb-agent-ubi:$(inputs.params.version)-context-arm64
        dockerfile: docker/mongodb-agent-non-matrix/Dockerfile

        labels:
          quay.expires-after: 48h

        output:
          - registry: $(inputs.params.registry)/mongodb-agent-ubi
            tag: $(inputs.params.version)-arm64
          - registry: $(inputs.params.registry)/mongodb-agent-ubi
            tag: latest-arm64

      - name: mongodb-agent-release
        task_type: docker_build
        tags: ["release"]
        dockerfile: docker/mongodb-agent-non-matrix/Dockerfile

        buildargs:
          imagebase: $(inputs.params.quay_registry):$(inputs.params.version)-context-arm64

        labels:
          quay.expires-after: Never

        output:
          - registry: $(inputs.params.quay_registry)
            tag: $(inputs.params.version)-arm64

      - name: mongodb-agent-template-ubi
        task_type: dockerfile_template
        tags: ["release"]
        output:
          - dockerfile: $(inputs.params.s3_bucket)/$(inputs.params.version)/ubi/Dockerfile
