vars:
  readiness_probe_repo: quay.io/mongodb/mongodb-kubernetes-readinessprobe
  quay_registry: quay.io/mongodb/mongodb-enterprise-init-appdb
  rh_registry: scan.connect.redhat.com/ospid-053baed4-c625-44bb-a9bf-a3a5585a17e8/mongodb-enterprise-init-appdb
  s3_bucket_http: https://enterprise-operator-dockerfiles.s3.amazonaws.com/dockerfiles/mongodb-enterprise-init-appdb
  s3_bucket: s3://enterprise-operator-dockerfiles/dockerfiles/mongodb-enterprise-init-appdb

images:
- name: init-appdb
  vars:
    context: .
    template_context: docker/mongodb-enterprise-init-database

  stages:
  - name: init-appdb-build-context
    task_type: docker_build
    dockerfile: docker/mongodb-enterprise-init-database/Dockerfile.builder

    buildargs:
      mongodb_tools_url_ubi: $(inputs.params.mongodb_tools_url_ubi)
      mongodb_tools_url_ubuntu: $(inputs.params.mongodb_tools_url_ubuntu)
      readiness_probe_version: $(inputs.params.readiness_probe_version)
      readiness_probe_repo: $(inputs.params.readiness_probe_repo)

    output:
    - registry: $(inputs.params.registry)/ubuntu/mongodb-enterprise-init-appdb-context
      tag: $(inputs.params.version_id)
  
  - name: init-appdb-template-ubuntu
    task_type: dockerfile_template
    distro: busybox
    tags: ["ubuntu"]

    inputs:
    - is_appdb

    output:
    - dockerfile: docker/mongodb-enterprise-init-database/Dockerfile.ubuntu-$(inputs.params.version)

  - name: init-appdb-build-ubuntu
    task_type: docker_build
    tags: ["ubuntu"]

    buildargs:
      version: $(inputs.params.version)
      imagebase: $(inputs.params.registry)/ubuntu/mongodb-enterprise-init-appdb-context:$(inputs.params.version_id)

    dockerfile: docker/mongodb-enterprise-init-database/Dockerfile.ubuntu-$(inputs.params.version)

    output:
    - registry: $(inputs.params.registry)/ubuntu/mongodb-enterprise-init-appdb
      tag: $(inputs.params.version_id)
    - registry: $(inputs.params.registry)/ubuntu/mongodb-enterprise-init-appdb
      tag: latest

  - name: init-appdb-template-ubi
    task_type: dockerfile_template
    distro: ubi_minimal
    tags: ["ubi"]

    inputs:
    - is_appdb

    output:
    - dockerfile: docker/mongodb-enterprise-init-database/Dockerfile.ubi-$(inputs.params.version)

  - name: init-appdb-build-ubi
    task_type: docker_build
    tags: ["ubi"]

    buildargs:
      version: $(inputs.params.version)
      imagebase: $(inputs.params.registry)/ubuntu/mongodb-enterprise-init-appdb-context:$(inputs.params.version_id)

    dockerfile: docker/mongodb-enterprise-init-database/Dockerfile.ubi-$(inputs.params.version)

    output:
    - registry: $(inputs.params.registry)/ubi/mongodb-enterprise-init-appdb
      tag: $(inputs.params.version_id)

  - name: init-appdb-release-context
    task_type: tag_image
    tags: ["release"]

    source:
      registry: $(inputs.params.registry)/ubuntu/mongodb-enterprise-init-appdb-context
      tag: $(inputs.params.version_id)

    destination:
    - registry: $(inputs.params.quay_registry)
      tag: $(inputs.params.version)-context

  - name: init-appdb-template-ubi
    task_type: dockerfile_template
    distro: ubi_minimal
    tags: ["release"]

    inputs:
    - is_appdb

    output:
    - dockerfile: $(inputs.params.s3_bucket)/Dockerfile.ubi-$(inputs.params.version)

  - name: init-appdb-template-ubuntu
    task_type: dockerfile_template
    distro: busybox
    tags: ["release"]

    inputs:
    - is_appdb

    output:
    - dockerfile: $(inputs.params.s3_bucket)/Dockerfile.ubuntu-$(inputs.params.version)


- name: init-appdb-daily
  vars:
    context: .

  stages:
  - name: build-ubuntu
    task_type: docker_build

    inputs:
    - build_id

    dockerfile: $(inputs.params.s3_bucket_http)/Dockerfile.ubuntu-$(inputs.params.release_version)
    buildargs:
      imagebase: $(inputs.params.quay_registry):$(inputs.params.release_version)-context

    output:
    - registry: $(inputs.params.quay_registry)
      tag: $(inputs.params.release_version)
    - registry: $(inputs.params.quay_registry)
      tag: $(inputs.params.release_version)-b$(inputs.params.build_id)

  - name: build-ubi
    task_type: docker_build

    inputs:
    - build_id

    dockerfile: $(inputs.params.s3_bucket_http)/Dockerfile.ubi-$(inputs.params.release_version)
    buildargs:
      imagebase: $(inputs.params.quay_registry):$(inputs.params.release_version)-context

    output:
    - registry: $(inputs.params.quay_registry)-ubi
      tag: $(inputs.params.release_version)
    - registry: $(inputs.params.quay_registry)-ubi
      tag: $(inputs.params.release_version)-b$(inputs.params.build_id)
    - registry: $(inputs.params.rh_registry)
      tag: $(inputs.params.release_version)-b$(inputs.params.build_id)
