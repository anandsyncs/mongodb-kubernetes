#!/usr/bin/env bash

set -euo pipefail

source scripts/funcs

recreate="${1-}"
CLUSTER="${2:-e2e.mongokubernetes.com}"

if [[ "${recreate}" != "yes" ]]; then
	fatal "Exiting as \"imsure=yes\" parameter is not specified"
fi

# make sure kops version is >= 1.11.0
kops_version=$(kops version | awk '{ print $2 }')
major=$(echo "$kops_version" | cut -d "." -f 1)
minor=$(echo "$kops_version" | cut -d "." -f 2)
if (( major != 1 || minor < 11 )); then
        fatal "kops must be of version >= 1.11.0!"
fi

title "Deleting kops cluster $CLUSTER"

# wait until the cluster is removed (could be removed already)
kops delete cluster $CLUSTER --yes || true

title "Cluster deleted"

# Note, that for e2e cluster we use us-east-2 region as us-east-1 most of all has reached max number of VPCs (5)
if [[ "${CLUSTER}" = "e2e.mongokubernetes.com" ]]; then
    # todo 2xlarge can be too big - this is a fix for the "2 OMs on one node" problem which should be solved by
    # pod anti affinity rule
    create_kops_cluster ${CLUSTER} 4 64 "t2.2xlarge" "t2.medium" "us-east-2a,us-east-2b,us-east-2c"
elif [[ "${CLUSTER}" = "e2e.om.mongokubernetes.com" ]]; then
    # this one is for Ops Manager e2e tests
    create_kops_cluster ${CLUSTER} 3 32 "t2.xlarge" "t2.medium" "us-west-2a,us-west-2b,us-west-2c"
else
    # we're creating a smaller cluster for specific tests
    # the only known "other" namespace is "e2e.multinamespace.mongokubernetes.com"
    create_kops_cluster ${CLUSTER} 2 16 "t2.medium" "t2.medium" "us-west-2a,us-west-2b,us-west-2c"
fi
