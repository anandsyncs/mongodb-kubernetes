apiVersion: mongodb.com/v1
kind: MongoDBOpsManager
metadata:
  name: om-pod-spec
spec:
  replicas: 1
  version: 4.2.0
  adminCredentials: ops-manager-admin-secret
  configuration:
    mms.testUtil.enabled: "true"
  backup:
    enabled: true
    statefulSet:
      spec:
        template:
          spec:
            hostAliases:
              - ip: "1.2.3.4"
                hostnames: ["hostname"]
            containers:
              - name: "mongodb-backup-daemon"
                resources:
                  requests:
                    cpu: '0.50'
                    memory: '4500M'

  statefulSet:
    spec:
      template:
        metadata:
          annotations:
            key1: value1
        spec:
          volumes:
            - name: test-volume
              emptyDir: {}
          tolerations:
            - key: "key"
              operator: "Exists"
              effect: "NoSchedule"
          containers:
            - name: mongodb-ops-manager
              securityContext:
                allowPrivilegeEscalation: false
                runAsNonRoot: true
                runAsUser: 1001
                runAsGroup: 1001
              readinessProbe:
                failureThreshold: 20
              volumeMounts:
                - mountPath: /somewhere
                  name: test-volume
              resources:
                limits:
                  cpu: '0.70'
                  memory: '6G'
          initContainers:
            - name: mongodb-enterprise-init-ops-manager
              securityContext:
                allowPrivilegeEscalation: false
                runAsNonRoot: true
                runAsUser: 1001
                runAsGroup: 1001

  applicationDatabase:
    members: 3
    version: 4.2.2-ent
    podSpec:
      persistence:
        single:
          storage: 1G
      podTemplate:
        spec:
          # TO kill sidecar right away
          terminationGracePeriodSeconds: 3
          # This container will be added to each pod as a sidecar
          containers:
            - name: appdb-sidecar
              image: busybox
              command: ["sleep"]
              args: [ "infinity" ]
              resources:
                limits:
                  cpu: "1"
                requests:
                  cpu: 500m
            - name: mongod
              securityContext:
                allowPrivilegeEscalation: false
                runAsNonRoot: true
                runAsUser: 1001
                runAsGroup: 1001
            - name: mongodb-agent-monitoring
              securityContext:
                allowPrivilegeEscalation: false
                runAsNonRoot: true
                runAsUser: 1001
                runAsGroup: 1001
            - name: mongodb-agent
              securityContext:
                allowPrivilegeEscalation: false
                runAsNonRoot: true
                runAsUser: 1001
                runAsGroup: 1001
              resources:
                limits:
                  cpu: '0.25'
                  memory: 350M

