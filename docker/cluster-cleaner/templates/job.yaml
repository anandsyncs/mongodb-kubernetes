---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: cluster-cleaner
  namespace: {{ .Values.cleanerNamespace }}

---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: cluster-cleaner
  namespace: {{ .Values.cleanerNamespace }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: cluster-cleaner
  namespace: {{ .Values.cleanerNamespace }}

# Remove old failed namespaces
---
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: cluster-cleaner-delete-each-hour
  namespace: {{ .Values.cleanerNamespace }}
spec:
  schedule: "16 * * * *"
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: cluster-cleaner
          restartPolicy: Never

          containers:
          - name: cluster-cleaner
            image: 268558157000.dkr.ecr.us-east-1.amazonaws.com/dev/cluster-cleaner:0.4
            imagePullPolicy: Always
            command: ["./clean-failed-namespaces.sh"]
            env:
            - name: DELETE_OLDER_THAN_UNIT
              value: "hours"
            - name: DELETE_OLDER_THAN_AMOUNT
              value: "1"

# Clean old certificates
---
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: cluster-cleaner-ca-certificates
  namespace: {{ .Values.cleanerNamespace }}
spec:
  # run every 10 minutes
  schedule: "*/10 * * * *"
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: cluster-cleaner
          restartPolicy: Never

          containers:
          - name: cluster-cleaner
            image: 268558157000.dkr.ecr.us-east-1.amazonaws.com/dev/cluster-cleaner:0.4
            imagePullPolicy: Always
            command: ["./create-cluster-ca-as-configmap.sh"]

# Remove old clusterroles
---
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: cluster-cleaner-cluster-roles-and-bindings
  namespace: {{ .Values.cleanerNamespace }}
spec:
  schedule: "46 * * * *"
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: cluster-cleaner
          restartPolicy: Never

          containers:
          - name: cluster-cleaner
            image: 268558157000.dkr.ecr.us-east-1.amazonaws.com/dev/cluster-cleaner:0.4
            imagePullPolicy: Always
            command: ["./clean-cluster-roles-and-bindings.sh"]
